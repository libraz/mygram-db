{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://mygramdb.dev/schemas/config.json",
  "title": "MygramDB Configuration Schema",
  "description": "JSON Schema for MygramDB configuration validation",
  "type": "object",
  "required": ["mysql", "tables"],
  "additionalProperties": false,
  "properties": {
    "mysql": {
      "type": "object",
      "description": "MySQL connection settings",
      "required": ["user", "database"],
      "additionalProperties": false,
      "properties": {
        "host": {
          "type": "string",
          "description": "MySQL server hostname or IP",
          "default": "127.0.0.1"
        },
        "port": {
          "type": "integer",
          "description": "MySQL server port",
          "default": 3306,
          "minimum": 1,
          "maximum": 65535
        },
        "user": {
          "type": "string",
          "description": "MySQL username for replication",
          "minLength": 1
        },
        "password": {
          "type": "string",
          "description": "MySQL user password"
        },
        "database": {
          "type": "string",
          "description": "Database name",
          "minLength": 1
        },
        "use_gtid": {
          "type": "boolean",
          "description": "Enable GTID-based replication",
          "default": true
        },
        "binlog_format": {
          "type": "string",
          "description": "Binary log format",
          "default": "ROW",
          "enum": ["ROW", "STATEMENT", "MIXED"]
        },
        "binlog_row_image": {
          "type": "string",
          "description": "Row image format",
          "default": "FULL",
          "enum": ["FULL", "MINIMAL", "NOBLOB"]
        },
        "connect_timeout_ms": {
          "type": "integer",
          "description": "Connection timeout in milliseconds",
          "default": 3000,
          "minimum": 100,
          "maximum": 60000
        },
        "read_timeout_ms": {
          "type": "integer",
          "description": "Read timeout in milliseconds (for long-running binlog connections)",
          "default": 3600000,
          "minimum": 1000,
          "maximum": 86400000
        },
        "write_timeout_ms": {
          "type": "integer",
          "description": "Write timeout in milliseconds",
          "default": 3600000,
          "minimum": 1000,
          "maximum": 86400000
        },
        "ssl_enable": {
          "type": "boolean",
          "description": "Enable SSL/TLS for MySQL connection",
          "default": false
        },
        "ssl_ca": {
          "type": "string",
          "description": "Path to CA certificate file for SSL/TLS"
        },
        "ssl_cert": {
          "type": "string",
          "description": "Path to client certificate file for SSL/TLS"
        },
        "ssl_key": {
          "type": "string",
          "description": "Path to client private key file for SSL/TLS"
        },
        "ssl_verify_server_cert": {
          "type": "boolean",
          "description": "Verify server certificate during SSL/TLS connection",
          "default": true
        }
      }
    },
    "tables": {
      "type": "array",
      "description": "Table configuration (supports multiple tables)",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["name"],
        "additionalProperties": false,
        "properties": {
          "name": {
            "type": "string",
            "description": "Table name in MySQL database",
            "minLength": 1
          },
          "primary_key": {
            "type": "string",
            "description": "Primary key column name",
            "default": "id"
          },
          "text_source": {
            "type": "object",
            "description": "Text source configuration",
            "additionalProperties": false,
            "properties": {
              "column": {
                "type": "string",
                "description": "Single column to index for full-text search"
              },
              "concat": {
                "type": "array",
                "description": "Multiple columns to concatenate",
                "items": {
                  "type": "string"
                },
                "minItems": 2
              },
              "delimiter": {
                "type": "string",
                "description": "Delimiter for concatenation",
                "default": " "
              }
            },
            "oneOf": [
              {
                "required": ["column"]
              },
              {
                "required": ["concat"]
              }
            ]
          },
          "required_filters": {
            "type": "array",
            "description": "Required filter conditions (data existence conditions)",
            "items": {
              "type": "object",
              "required": ["name", "type", "op"],
              "additionalProperties": false,
              "properties": {
                "name": {
                  "type": "string",
                  "description": "Filter column name"
                },
                "type": {
                  "type": "string",
                  "description": "Column type",
                  "enum": [
                    "tinyint", "tinyint_unsigned",
                    "smallint", "smallint_unsigned",
                    "int", "int_unsigned",
                    "bigint",
                    "float", "double",
                    "string", "varchar", "text",
                    "datetime", "date", "timestamp"
                  ]
                },
                "op": {
                  "type": "string",
                  "description": "Comparison operator",
                  "enum": ["=", "!=", "<", ">", "<=", ">=", "IS NULL", "IS NOT NULL"]
                },
                "value": {
                  "description": "Comparison value (not required for IS NULL/IS NOT NULL)"
                },
                "bitmap_index": {
                  "type": "boolean",
                  "description": "Enable bitmap index for search-time filtering",
                  "default": false
                }
              }
            }
          },
          "filters": {
            "type": "array",
            "description": "Optional filter columns for search-time filtering",
            "items": {
              "type": "object",
              "required": ["name", "type"],
              "additionalProperties": false,
              "properties": {
                "name": {
                  "type": "string",
                  "description": "Filter column name"
                },
                "type": {
                  "type": "string",
                  "description": "Column type",
                  "enum": [
                    "tinyint", "tinyint_unsigned",
                    "smallint", "smallint_unsigned",
                    "int", "int_unsigned",
                    "bigint",
                    "float", "double",
                    "string", "varchar", "text",
                    "datetime", "date", "timestamp"
                  ]
                },
                "dict_compress": {
                  "type": "boolean",
                  "description": "Enable dictionary compression",
                  "default": false
                },
                "bitmap_index": {
                  "type": "boolean",
                  "description": "Enable bitmap indexing",
                  "default": false
                },
                "bucket": {
                  "type": "string",
                  "description": "Bucket datetime values",
                  "enum": ["minute", "hour", "day"]
                }
              }
            }
          },
          "ngram_size": {
            "type": "integer",
            "description": "N-gram size for ASCII/alphanumeric characters (1=unigram, 2=bigram, etc.)",
            "default": 2,
            "minimum": 1,
            "maximum": 10
          },
          "kanji_ngram_size": {
            "type": "integer",
            "description": "N-gram size for CJK (kanji/kana/hanzi) characters. 0 or omit to use ngram_size.",
            "default": 0,
            "minimum": 0,
            "maximum": 10
          },
          "posting": {
            "type": "object",
            "description": "Posting list configuration",
            "additionalProperties": false,
            "properties": {
              "block_size": {
                "type": "integer",
                "description": "Block size for delta encoding",
                "default": 128,
                "minimum": 8,
                "maximum": 1024
              },
              "freq_bits": {
                "type": "integer",
                "description": "Term frequency bits: 0=boolean, 4, or 8",
                "default": 0,
                "enum": [0, 4, 8]
              },
              "use_roaring": {
                "type": "string",
                "description": "Roaring bitmap usage",
                "default": "auto",
                "enum": ["auto", "always", "never"]
              }
            }
          }
        }
      }
    },
    "build": {
      "type": "object",
      "description": "Index build configuration",
      "additionalProperties": false,
      "properties": {
        "mode": {
          "type": "string",
          "description": "Build mode",
          "default": "select_snapshot",
          "enum": ["select_snapshot"]
        },
        "batch_size": {
          "type": "integer",
          "description": "Rows per batch during snapshot",
          "default": 5000,
          "minimum": 100,
          "maximum": 100000
        },
        "parallelism": {
          "type": "integer",
          "description": "Number of parallel build threads",
          "default": 2,
          "minimum": 1,
          "maximum": 64
        },
        "throttle_ms": {
          "type": "integer",
          "description": "Throttle delay between batches in milliseconds",
          "default": 0,
          "minimum": 0,
          "maximum": 10000
        }
      }
    },
    "replication": {
      "type": "object",
      "description": "Replication configuration",
      "additionalProperties": false,
      "properties": {
        "enable": {
          "type": "boolean",
          "description": "Enable binlog replication",
          "default": true
        },
        "auto_initial_snapshot": {
          "type": "boolean",
          "description": "Automatically build snapshots on server startup (default: false)",
          "default": false
        },
        "server_id": {
          "type": "integer",
          "description": "MySQL server ID (REQUIRED, must be non-zero and unique)",
          "minimum": 1,
          "maximum": 4294967295
        },
        "start_from": {
          "type": "string",
          "description": "Replication start position",
          "default": "snapshot"
        },
        "queue_size": {
          "type": "integer",
          "description": "Binlog event queue size",
          "default": 10000,
          "minimum": 100,
          "maximum": 1000000
        },
        "reconnect_backoff_min_ms": {
          "type": "integer",
          "description": "Minimum reconnect backoff delay",
          "default": 500,
          "minimum": 100,
          "maximum": 60000
        },
        "reconnect_backoff_max_ms": {
          "type": "integer",
          "description": "Maximum reconnect backoff delay",
          "default": 10000,
          "minimum": 1000,
          "maximum": 600000
        }
      },
      "if": {
        "properties": {
          "enable": {
            "const": true
          }
        }
      },
      "then": {
        "required": ["server_id"]
      }
    },
    "memory": {
      "type": "object",
      "description": "Memory management configuration",
      "additionalProperties": false,
      "properties": {
        "hard_limit_mb": {
          "type": "integer",
          "description": "Hard memory limit in MB",
          "default": 8192,
          "minimum": 256
        },
        "soft_target_mb": {
          "type": "integer",
          "description": "Soft memory target in MB",
          "default": 4096,
          "minimum": 128
        },
        "arena_chunk_mb": {
          "type": "integer",
          "description": "Arena chunk size in MB",
          "default": 64,
          "minimum": 1,
          "maximum": 1024
        },
        "roaring_threshold": {
          "type": "number",
          "description": "Roaring bitmap threshold",
          "default": 0.18,
          "minimum": 0.0,
          "maximum": 1.0
        },
        "minute_epoch": {
          "type": "boolean",
          "description": "Use minute-precision epoch",
          "default": true
        },
        "normalize": {
          "type": "object",
          "description": "Text normalization settings",
          "additionalProperties": false,
          "properties": {
            "nfkc": {
              "type": "boolean",
              "description": "NFKC normalization",
              "default": true
            },
            "width": {
              "type": "string",
              "description": "Width conversion",
              "default": "narrow",
              "enum": ["keep", "narrow", "wide"]
            },
            "lower": {
              "type": "boolean",
              "description": "Lowercase conversion",
              "default": false
            }
          }
        }
      }
    },
    "dump": {
      "type": "object",
      "description": "Dump persistence configuration",
      "additionalProperties": false,
      "properties": {
        "dir": {
          "type": "string",
          "description": "Dump directory path",
          "default": "/var/lib/mygramdb/dumps"
        },
        "default_filename": {
          "type": "string",
          "description": "Default filename for manual DUMP SAVE",
          "default": "mygramdb.dmp"
        },
        "interval_sec": {
          "type": "integer",
          "description": "Dump interval in seconds (0 = disabled, 7200 = 120 minutes recommended)",
          "default": 0,
          "minimum": 0,
          "maximum": 86400
        },
        "retain": {
          "type": "integer",
          "description": "Number of dumps to retain",
          "default": 3,
          "minimum": 1,
          "maximum": 100
        }
      }
    },
    "api": {
      "type": "object",
      "description": "API server configuration",
      "additionalProperties": false,
      "properties": {
        "tcp": {
          "type": "object",
          "description": "TCP server configuration",
          "additionalProperties": false,
          "properties": {
            "bind": {
              "type": "string",
              "description": "TCP bind address",
              "default": "127.0.0.1"
            },
            "port": {
              "type": "integer",
              "description": "TCP port",
              "default": 11016,
              "minimum": 1,
              "maximum": 65535
            }
          }
        },
        "http": {
          "type": "object",
          "description": "HTTP server configuration",
          "additionalProperties": false,
          "properties": {
            "enable": {
              "type": "boolean",
              "description": "Enable HTTP server",
              "default": false
            },
            "bind": {
              "type": "string",
              "description": "HTTP bind address",
              "default": "127.0.0.1"
            },
            "port": {
              "type": "integer",
              "description": "HTTP port",
              "default": 8080,
              "minimum": 1,
              "maximum": 65535
            },
            "enable_cors": {
              "type": "boolean",
              "description": "Enable CORS headers",
              "default": false
            },
            "cors_allow_origin": {
              "type": "string",
              "description": "Value for Access-Control-Allow-Origin header when CORS is enabled",
              "default": ""
            }
          }
        },
        "default_limit": {
          "type": "integer",
          "description": "Default LIMIT for SEARCH queries when not explicitly specified",
          "default": 100,
          "minimum": 5,
          "maximum": 1000
        },
        "max_query_length": {
          "type": "integer",
          "description": "Maximum character length allowed for search query expressions (text + conditions)",
          "default": 128,
          "minimum": 1,
          "maximum": 4096
        },
        "rate_limiting": {
          "type": "object",
          "description": "Rate limiting configuration (token bucket algorithm)",
          "additionalProperties": false,
          "properties": {
            "enable": {
              "type": "boolean",
              "description": "Enable rate limiting",
              "default": false
            },
            "capacity": {
              "type": "integer",
              "description": "Maximum number of tokens per client (burst size)",
              "default": 100,
              "minimum": 1,
              "maximum": 10000
            },
            "refill_rate": {
              "type": "integer",
              "description": "Tokens added per second per client",
              "default": 10,
              "minimum": 1,
              "maximum": 1000
            },
            "max_clients": {
              "type": "integer",
              "description": "Maximum number of tracked clients (for memory management)",
              "default": 10000,
              "minimum": 10,
              "maximum": 100000
            }
          }
        }
      }
    },
    "server": {
      "type": "object",
      "description": "Legacy server configuration (deprecated, use api.tcp instead)",
      "additionalProperties": false,
      "properties": {
        "host": {
          "type": "string",
          "description": "Server bind address (deprecated, use api.tcp.bind)"
        },
        "port": {
          "type": "integer",
          "description": "Server port (deprecated, use api.tcp.port)",
          "minimum": 1,
          "maximum": 65535
        }
      }
    },
    "network": {
      "type": "object",
      "description": "Network security configuration",
      "additionalProperties": false,
      "properties": {
        "allow_cidrs": {
          "type": "array",
          "description": "Allow CIDR list (empty = allow all)",
          "items": {
            "type": "string",
            "pattern": "^([0-9]{1,3}\\.){3}[0-9]{1,3}/[0-9]{1,2}$"
          }
        }
      }
    },
    "logging": {
      "type": "object",
      "description": "Logging configuration",
      "additionalProperties": false,
      "properties": {
        "level": {
          "type": "string",
          "description": "Log level",
          "default": "info",
          "enum": ["debug", "info", "warn", "error"]
        },
        "json": {
          "type": "boolean",
          "description": "JSON format output",
          "default": true
        },
        "file": {
          "type": "string",
          "description": "Log file path (empty string = stdout, path = file output)",
          "default": ""
        }
      }
    },
    "cache": {
      "type": "object",
      "description": "Query cache configuration",
      "additionalProperties": false,
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable/disable cache",
          "default": true
        },
        "max_memory_mb": {
          "type": "integer",
          "description": "Maximum cache memory in MB",
          "default": 32,
          "minimum": 1
        },
        "min_query_cost_ms": {
          "type": "number",
          "description": "Minimum query cost to cache (ms)",
          "default": 10.0,
          "minimum": 0.0
        },
        "ttl_seconds": {
          "type": "integer",
          "description": "Cache entry TTL (seconds, 0 = no TTL)",
          "default": 3600,
          "minimum": 0
        },
        "invalidation_strategy": {
          "type": "string",
          "description": "Invalidation strategy",
          "default": "ngram",
          "enum": ["ngram", "table"]
        },
        "compression_enabled": {
          "type": "boolean",
          "description": "Enable LZ4 compression",
          "default": true
        },
        "eviction_batch_size": {
          "type": "integer",
          "description": "Number of entries to evict at once",
          "default": 10,
          "minimum": 1
        },
        "invalidation": {
          "type": "object",
          "description": "Invalidation queue settings",
          "additionalProperties": false,
          "properties": {
            "batch_size": {
              "type": "integer",
              "description": "Process after N unique pairs",
              "default": 1000,
              "minimum": 1
            },
            "max_delay_ms": {
              "type": "integer",
              "description": "Max delay before processing (ms)",
              "default": 100,
              "minimum": 0
            }
          }
        }
      }
    }
  }
}
