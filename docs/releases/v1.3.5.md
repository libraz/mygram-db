# MygramDB v1.3.5 Release Notes

**Release Date:** 2025-11-26
**Type:** Performance Release
**Previous Version:** v1.3.4

---

## Overview

Version 1.3.5 is a performance-focused release that dramatically improves parallel query execution performance. Key improvements include eliminating lock contention in the result sorter, optimizing I/O operations with zero-copy techniques, and fixing a primary key sort optimization bug.

**Highlights:**

- **99.9996% reduction** in lock acquisitions during parallel query execution
- **10x faster** numeric formatting with locale-independent std::to_chars
- **Zero-copy I/O** with writev() for response sending
- Primary key column name sort optimization fix

---

## Performance Improvements

### 1. Schwartzian Transform for Parallel Query Execution

**Type:** Performance Critical

Eliminates lock contention bottlenecks in ResultSorter that caused severe performance degradation during parallel query execution.

**Key Changes:**

- Add `SortWithSchwartzianTransformPartial()` method combining Schwartzian Transform with partial_sort
- Uses `GetPrimaryKeysBatch()` for single-lock batch lookup instead of per-comparison locks
- Pre-computes all sort keys before sorting (O(N) lookups with 1 lock acquisition)
- Then uses partial_sort on pre-computed keys (O(N log K) comparisons, no locks)

**Performance Impact:**

- **Before:** 2N log K lock acquisitions per comparison during sort
- **After:** 1 batch lookup (1 lock) + N log K string comparisons (no locks)
- For 100 parallel queries with N=10,000, K=100:
  - Before: ~26.5M lock acquisitions total
  - After: ~100 lock acquisitions total (**99.9996% reduction**)

**Memory Safety:**

- Add `kSchwartzianTransformMaxSize` constant (5M entries, ~500MB limit)
- Prevents memory explosion for very large result sets
- Falls back to traditional partial_sort beyond threshold

**Files Changed:**

- `src/query/result_sorter.cpp` - New method and ToZeroPaddedString helper
- `src/query/result_sorter.h` - Add kSchwartzianTransformMaxSize and method declaration

### 2. snprintf Replacement with std::to_chars

**Type:** Performance

Eliminates `os_unfair_lock` contention from `localeconv_l` during parallel execution.

**Problem:** snprintf acquires a lock for locale information on every call, causing severe contention when multiple threads format numbers simultaneously.

**Solution:**

- Add `ToZeroPaddedString()` using std::to_chars (C++17, locale-independent)
- ~10x faster than snprintf for numeric formatting
- No lock contention during parallel execution

### 3. Zero-Copy I/O with writev()

**Type:** Performance

Replace individual `send()` calls with vectored I/O for response sending.

**Changes:**

- Replace `send()` with `writev()` for zero-copy response sending
- Reduces system call overhead by batching multiple buffers

**SIGPIPE Handling:**

- Add process-wide SIGPIPE ignore (writev doesn't support MSG_NOSIGNAL)
- Add SO_NOSIGPIPE socket option on macOS

### 4. Batch Primary Key Lookups

**Type:** Performance

Optimize DocumentStore access patterns for better lock efficiency.

**Changes:**

- Add `DocumentStore::GetPrimaryKeysBatch()` for single lock acquisition
- ResponseFormatter uses batch API and pre-allocated buffers
- ProcessBuffer uses indices instead of repeated substr() copies

---

## Bug Fixes

### 1. Primary Key Column Name Sort Optimization

**Severity:** Medium - Performance Regression

**Problem:** Explicit primary key column name (e.g., "SORT id ASC") was not recognized as equivalent to implicit primary key sort ("SORT ASC"), causing different execution plans for semantically identical queries.

**Symptoms:**

- `SEARCH table term SORT ASC LIMIT 100` - Uses optimized path
- `SEARCH table term SORT id ASC LIMIT 100` - Falls back to slower path

**Fix:**

- ResultSorter now checks both empty column (shorthand) and explicit primary key name
- SearchHandler moves primary key column lookup earlier for optimization check
- Ensures consistent execution plan for primary key ordering

**Files Changed:**

- `src/query/result_sorter.cpp` - Add primary key name equivalence check
- `src/server/handlers/search_handler.cpp` - Earlier primary key column lookup

### 2. Index Search Optimization (RCU Pattern)

**Type:** Performance Fix

**Problem:** Index searches held locks during the entire search operation, blocking concurrent reads.

**Solution:**

- Add `TakePostingSnapshots()` and `TakePostingSnapshot()` methods
- Take short lock to copy shared_ptrs, then search without lock
- Reduces lock contention under high read concurrency

**Files Changed:**

- `src/index/index.cpp` - Add snapshot methods
- `src/index/index.h` - Declare snapshot methods

---

## New Features

### 1. OPTIMIZE Command Table Parameter

**Type:** Enhancement

The OPTIMIZE command now accepts an optional table parameter for multi-table deployments.

```text
OPTIMIZE             -- Optimize all tables
OPTIMIZE users       -- Optimize specific table
```

**Files Changed:**

- `src/query/query_parser.cpp` - Parse optional table parameter

### 2. Python Benchmark Tool

**Type:** Tooling

New Python benchmark tool for comparing MygramDB and MySQL FULLTEXT performance.

**Location:** `support/benchmark/`

**Features:**

- Automated benchmark execution
- Configurable concurrency levels
- CSV/JSON output formats
- Latency percentile reporting (P50, P95, P99)

**Usage:**

```bash
cd support/benchmark
pip install -r requirements.lock
python benchmark.py --help
```

---

## Files Changed

| File | Changes |
|------|---------|
| `src/query/result_sorter.cpp` | Schwartzian Transform, ToZeroPaddedString |
| `src/query/result_sorter.h` | New method declarations |
| `src/index/index.cpp` | RCU pattern with posting snapshots |
| `src/index/index.h` | Snapshot method declarations |
| `src/server/handlers/search_handler.cpp` | Primary key column lookup optimization |
| `src/server/connection_io_handler.cpp` | writev() implementation |
| `src/server/connection_acceptor.cpp` | SO_NOSIGPIPE for macOS |
| `src/server/response_formatter.cpp` | Batch API usage |
| `src/storage/document_store.cpp` | GetPrimaryKeysBatch() method |
| `src/storage/document_store.h` | Batch method declaration |
| `src/query/query_parser.cpp` | OPTIMIZE table parameter |
| `src/app/signal_manager.cpp` | SIGPIPE handling |
| `src/app/signal_manager.h` | Signal handler declarations |
| `support/benchmark/` | New Python benchmark tool |

---

## Benchmark Results

Benchmark conducted with 1,696,904 row dataset, MygramDB with `cache.enabled: false`.

### Parallel Query Performance Improvement (v1.3.4 → v1.3.5)

This release dramatically improves parallel query performance:

| Scenario | v1.3.4 | v1.3.5 | Improvement |
|----------|--------|--------|-------------|
| 10 concurrent | Avg 1,232ms, QPS 7.8 | Avg 32ms, QPS 288 | **37x faster** |
| 100 concurrent | Avg 7,219ms, QPS 10.6 | Avg 190ms, QPS 372 | **35x faster** |
| OFFSET+20 concurrent | Avg 2,408ms, QPS 2.1 | Avg 52ms, QPS 94 | **45x faster** |

### Parallel Query Results (v1.3.5)

**10 Concurrent (SORT id LIMIT 100):**

| System | Total | Success | Failed | Avg | P50 | P95 | QPS | Notes |
|--------|-------|---------|--------|-----|-----|-----|-----|-------|
| MySQL | 80 | 8 | 72 | 4,641ms | 4,636ms | - | 0.4 | **90% failed** |
| MygramDB | 80 | 80 | 0 | **32ms** | **35ms** | **53ms** | **288** | **100% success** |

**QPS: 720x faster than MySQL** (0.4 → 288)

**100 Concurrent (MygramDB only):**

| System | Total | Success | Failed | Avg | P50 | P95 | P99 | QPS |
|--------|-------|---------|--------|-----|-----|-----|-----|-----|
| MySQL | - | - | - | - | - | - | - | N/A (cannot execute) |
| MygramDB | 200 | 200 | 0 | **190ms** | **218ms** | **280ms** | **290ms** | **372** |

**Deep OFFSET + 20 Concurrent (OFFSET 10000):**

| System | Total | Success | Failed | Avg | QPS | Notes |
|--------|-------|---------|--------|-----|-----|-------|
| MySQL | 5 | 5 | 0 | 16,869ms | 0.3 | Extremely slow |
| MygramDB | 5 | 5 | 0 | **52ms** | **94** | **324x faster** |

### Single Query Results

| Term | Hit Rate | MySQL (Warm) | MygramDB | Speedup |
|------|----------|--------------|----------|---------|
| Ultra high-freq | 75.2% | 2,980ms | 92ms | **32x** |
| High-freq | 47.5% | 1,876ms | 76ms | **25x** |
| Medium-freq | 22.1% | 908ms | 49ms | **19x** |

### COUNT Query Results

| Term | Hit Count | MySQL (Warm) | MygramDB | Speedup |
|------|-----------|--------------|----------|---------|
| Ultra high-freq | 1.28M | 2,891ms | 6.7ms | **431x** |
| Low-freq | 42K | 124ms | 0.3ms | **413x** |

---

## Summary

### Single Query Performance

| Scenario | MySQL | MygramDB | Speedup |
|----------|-------|----------|---------|
| SORT id LIMIT 100 | 908-2,980ms | 22-92ms | **19-32x** |
| Deep OFFSET | 3,032-3,064ms | 100-139ms | **22-30x** |
| COUNT | 124-2,891ms | 0.3-6.7ms | **413-431x** |

### Parallel Performance

| Scenario | MySQL | MygramDB | Speedup |
|----------|-------|----------|---------|
| 10 concurrent | 90% failed, QPS 0.4 | **100% success, QPS 288** | **720x** |
| 100 concurrent | Cannot execute | **QPS 372** | - |
| OFFSET+20 concurrent | 16,869ms, QPS 0.3 | **52ms, QPS 94** | **324x** |

**Conclusions:**

- Single query: 19-32x faster than MySQL
- COUNT query: 413-431x faster than MySQL
- Parallel performance: MySQL collapses (90% failure), MygramDB achieves **QPS 372**
- Maximum QPS: **372** (100 concurrent queries)

---

## Upgrade Instructions

### From v1.3.4 or earlier

1. Stop MygramDB
2. Upgrade to v1.3.5
3. Restart MygramDB

No configuration changes required.

---

## Known Issues

None.

---

## Migration Notes

No migration required. This is a backward-compatible release.
