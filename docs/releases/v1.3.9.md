# MygramDB v1.3.9 Release Notes

**Release Date:** 2026-01-10
**Type:** Bug Fix & Performance Release
**Previous Version:** v1.3.8

---

## Overview

Version 1.3.9 is a comprehensive release addressing critical bugs in binlog replication, memory management, and data integrity. This release also includes significant performance improvements, MySQL compatibility enhancements, and code quality refinements.

**Highlights:**

- **Binlog Replication Fixes** - Fix thread premature termination, multi-row event handling, and GTID updates
- **Memory Management** - RAII wrapper for Roaring iterator, PostingList cleanup, N-gram map eviction
- **MySQL Compatibility** - GEOMETRY type, ROW_V1/ROTATE_EVENT/HEARTBEAT_EVENT, binlog_row_image=MINIMAL/NOBLOB
- **Performance Optimizations** - QueryCache lock upgrade, heterogeneous lookup, response string concatenation
- **Data Integrity** - Atomic document store updates, UTF-8 validation, calendar date validation
- **Code Quality** - Extract binary I/O helpers, consolidate duplicate code, improve exception handling

---

## Bug Fixes

### 1. Binlog Replication Critical Fixes

**Type:** Bug Fix
**Severity:** Critical

Fixed multiple critical issues in binlog replication that could cause event loss or data inconsistency.

**Issues Resolved:**

- **Thread Premature Termination** - Binlog reader thread was terminating after first event batch
- **Multi-row Event Handling** - INSERT/UPDATE/DELETE events with multiple rows now processed correctly
- **text_source.concat Processing** - All columns in configuration now processed properly
- **GTID Update Timing** - GTID only updated on successful event processing
- **Final Batch Indexing** - Fix indexing issue in InitialLoader's final batch
- **Graceful Shutdown** - Prevent event loss during shutdown
- **Use-after-free** - Fix crash in reader thread cleanup

**Files Changed:**

- `src/mysql/binlog_reader.cpp`
- `src/mysql/binlog_event_processor.cpp`
- `src/mysql/binlog_event_parser.cpp`
- `src/mysql/rows_parser.cpp`
- `src/loader/initial_loader.cpp`

### 2. Memory and Resource Management

**Type:** Bug Fix
**Severity:** High

Fixed memory leaks and resource management issues.

**Issues Resolved:**

- **RAII Wrapper for Roaring Iterator** - Prevent memory leaks with proper RAII pattern
- **PostingList Cleanup** - Clean up empty PostingList objects after removal
- **N-gram Map Eviction** - Limit map growth with eviction policy
- **SearchAnd Optimization** - Avoid full document materialization
- **Metadata Leak** - Fix leak in InvalidationManager
- **ClearTable Callback** - Invoke eviction callback properly

**Files Changed:**

- `src/index/index.cpp`
- `src/index/posting_list.cpp`
- `src/cache/invalidation_manager.cpp`

### 3. Query and Search Fixes

**Type:** Bug Fix
**Severity:** Medium

Fixed calculation and handling issues in query processing.

**Issues Resolved:**

- **Zero-division Guard** - Add guard in search optimization
- **total_results Calculation** - Fix calculation after filter application
- **Missing Filter Operators** - Add handlers for previously unsupported operators
- **Response Formatter Size** - Fix size mismatch issue
- **Cache TOCTOU Race** - Resolve race condition in cache lookup

**Files Changed:**

- `src/server/handlers/search_handler.cpp`
- `src/server/response_formatter.cpp`
- `src/cache/query_cache.cpp`

### 4. UTF-8 and String Handling

**Type:** Bug Fix
**Severity:** Medium

Improved UTF-8 validation to reject malformed input.

**Issues Resolved:**

- Validate UTF-8 continuation bytes
- Reject surrogate pair encodings
- Detect overlong UTF-8 encodings
- Prevent surrogate encoding in CodepointsToUtf8

**Files Changed:**

- `src/utils/string_utils.cpp`

### 5. GTID and Concurrency Fixes

**Type:** Bug Fix
**Severity:** High

Fixed race conditions and concurrency issues in GTID handling.

**Issues Resolved:**

- **gtid_encoded_data_ Race** - Fix race condition in callback
- **Transaction ID Overflow** - Handle overflow at INT64_MAX
- **UpdateCurrentGTID Protection** - Protect from concurrent access
- **Empty Interval Rejection** - Reject empty intervals in GTID set creation
- **Active Worker Counter Race** - Fix race condition
- **Rate Limiter Deadlock** - Resolve double-lock deadlock risk
- **Processed Events Counter** - Protect with atomic operations

**Files Changed:**

- `src/mysql/gtid_encoder.cpp`
- `src/mysql/binlog_reader.cpp`

### 6. Date/Time Handling

**Type:** Bug Fix
**Severity:** Low

Improved date/time parsing accuracy.

**Issues Resolved:**

- Preserve fractional seconds in time parsing
- Validate calendar dates (reject Feb 30, etc.)

**Files Changed:**

- `src/utils/datetime_converter.cpp`

### 7. Server and Protocol Fixes

**Type:** Bug Fix
**Severity:** Medium

**Issues Resolved:**

- Add bounds checking for SET command parsing
- Handle unterminated escape sequences at EOF
- Return error response when thread pool is full

**Files Changed:**

- `src/server/connection_acceptor.cpp`
- `src/query/query_parser.cpp`

### 8. Configuration and Security Fixes

**Type:** Bug Fix
**Severity:** High

**Issues Resolved:**

- Fix TOCTOU race in ApplyMysqlHost/Port
- Add mutex protection for base_config_ modifications
- Add validation for required fields
- **Prevent path traversal** in SSL/log/dump paths
- Fix integer overflow in max_memory_mb
- **Fix symlink security vulnerability** in path validation

**Files Changed:**

- `src/config/config.cpp`
- `src/config/runtime_variable_manager.cpp`

### 9. Concurrent Document Write Race Condition

**Type:** Bug Fix
**Severity:** High

Fix race condition in concurrent document writes that could cause data corruption.

**Files Changed:**

- `src/storage/document_store.cpp`

### 10. SYNC Instance Replacement Breaking Replication

**Type:** Bug Fix
**Severity:** Critical

Fix bug where replication events were not reflected in search results after SYNC cancellation or failure.

**Root Cause:**

When SYNC was cancelled or failed, the cleanup code created new Index/DocumentStore instances using `make_unique`. This broke the pointers that BinlogReader holds through TableContext, causing replication events to be written to the old (discarded) instances while search queries used the new (empty) instances.

**Fix:**

Use `Clear()` method instead of `make_unique` to preserve instance pointers. This ensures BinlogReader continues to write to the same Index/DocumentStore instances that SYNC and search queries use.

**Symptoms Resolved:**

- Replication events not appearing in search results after SYNC STOP
- Data loss after SYNC failure/cancellation
- Inconsistent state between replication and search

**Files Changed:**

- `src/server/sync_operation_manager.cpp`

### 11. CRC32 Calculation Type Warning

**Type:** Bug Fix
**Severity:** Low

Fix compiler warning in CRC32 streaming calculation by using explicit `std::min<size_t>` template parameter.

**Files Changed:**

- `src/storage/dump_format_v1.cpp`

---

## Diagnostic Improvements

### Debug Logging for Instance Tracking

Add debug logging to track DocumentStore instance addresses and sizes. This helps diagnose issues where different components might be using different instances.

**Logged Information:**

- `doc_store_addr` - Memory address of DocumentStore instance
- `doc_store_size` - Current document count
- `table` - Table name (in InitialLoader)
- `event_type` / `primary_key` - Event details (in BinlogEventProcessor)

**Files Changed:**

- `src/loader/initial_loader.cpp`
- `src/mysql/binlog_event_processor.cpp`

---

## Performance Improvements

### 1. QueryCache Lock Optimization

Optimize lock upgrade pattern in QueryCache for better concurrent access performance.

### 2. Heterogeneous Lookup

Implement heterogeneous lookup for Index and DocumentStore to avoid unnecessary string copies.

### 3. Response String Concatenation

Improve response string concatenation performance using reserve() and efficient appending.

### 4. ApplyFilters Variant Overhead

Optimize variant overhead in ApplyFilters for faster filter evaluation.

### 5. DDL O(N^2) Search

Fix O(N^2) complexity in DDL schema change detection search.

**Files Changed:**

- `src/cache/query_cache.cpp`
- `src/index/index.cpp`
- `src/storage/document_store.cpp`
- `src/server/response_formatter.cpp`
- `src/mysql/binlog_filter_evaluator.cpp`

---

## New Features

### 1. GEOMETRY Type Support

Add support for MySQL GEOMETRY column type in binlog replication.

### 2. Additional Binlog Event Types

Add handling for:
- ROW_V1 events
- ROTATE_EVENT
- HEARTBEAT_EVENT

### 3. binlog_row_image Support

Support for MySQL's `binlog_row_image` settings:
- MINIMAL
- NOBLOB

### 4. DECIMAL Precision Handling

Improved DECIMAL type precision handling for accurate numeric data.

### 5. Environment Variable Credentials

Load MySQL credentials from environment variables for improved security.

### 6. Strong DocId Typing

Add strong typing for DocId to prevent type confusion errors.

### 7. BinlogEvent Factory Pattern

Implement factory pattern for BinlogEvent to ensure invariants.

**Files Changed:**

- `src/mysql/binlog_event_parser.cpp`
- `src/mysql/binlog_event_types.h`
- `src/mysql/rows_parser.cpp`
- `src/types/doc_id.h`
- `src/config/config.cpp`

---

## Infrastructure Improvements

### 1. Atomic File Writes

Implement fsync/fdatasync and atomic write pattern (temp file + rename) for data durability.

### 2. Unified Endianness Handling

Unify endianness handling with proper little-endian support across all modules.

### 3. ICU Macro Fix

Fix U_SUCCESS macro misuse that could cause incorrect behavior.

### 4. Locale-Independent Number Formatting

Replace snprintf with std::to_chars to avoid locale conflicts in number formatting.

### 5. MySQL Connection Improvements

- Fix charset handling with `SET NAMES utf8mb4`
- Add mysql_options error checking

**Files Changed:**

- `src/storage/dump_format_v1.cpp`
- `src/utils/endian_utils.h`
- `src/mysql/connection.cpp`

---

## Code Quality Improvements

### 1. Binary I/O Helpers

Extract binary I/O helpers to `utils/binary_io.h` for reuse across modules.

### 2. Byte Constants

Extract byte constants to `utils/constants.h` for consistency.

### 3. Datetime Conversion Consolidation

Consolidate duplicate datetime conversion logic in datetime_converter.cpp.

### 4. ROWS_EVENT Processing Consolidation

Consolidate duplicate ROWS_EVENT processing code in binlog_event_parser.cpp.

### 5. Exception Handling Improvement

Improve exception handling with specific catch blocks instead of catch-all.

### 6. std::from_chars Migration

Replace manual parsing with std::from_chars where applicable for safety and performance.

### 7. Lambda Cleanup

Remove redundant lambda expressions.

**New Files:**

- `src/utils/binary_io.h`
- `src/utils/constants.h`
- `src/utils/endian_utils.h`
- `src/utils/hash_utils.h`
- `src/types/doc_id.h`

---

## Testing

### New Test Files

- `tests/cache/invalidation_manager_test.cpp` - InvalidationManager coverage
- `tests/cache/query_cache_test.cpp` - QueryCache coverage
- `tests/index/index_bug_fixes_test.cpp` - Index bug fix tests
- `tests/loader/initial_loader_bug_fixes_test.cpp` - InitialLoader bug fix tests
- `tests/mysql/binlog_event_parser_bug_fixes_test.cpp` - Parser bug fix tests
- `tests/mysql/binlog_event_processor_bug_fixes_test.cpp` - Processor bug fix tests
- `tests/mysql/binlog_reader_bug_fixes_test.cpp` - Reader bug fix tests
- `tests/mysql/rows_parser_bug_fixes_test.cpp` - Rows parser comprehensive tests
- `tests/server/search_handler_bug_fixes_test.cpp` - Search handler tests
- `tests/server/sync_instance_preservation_test.cpp` - SYNC instance pointer preservation tests
- `tests/storage/atomic_write_test.cpp` - Atomic write tests
- `tests/storage/endian_serialization_test.cpp` - Endianness tests

### Test Coverage Improvements

- Binlog rollback scenarios
- Boundary value testing
- DECIMAL precision testing
- ROW_V1 event handling
- GEOMETRY type handling

---

## Files Changed Summary

| Category | Count |
|----------|-------|
| Bug Fixes | 35+ files |
| New Features | 10+ files |
| Performance | 8 files |
| Code Quality | 11 files |
| New Utilities | 5 files |
| Tests | 15+ files |

**Total: 107 files changed, ~10,000 insertions, ~1,500 deletions**

---

## Upgrade Instructions

### From v1.3.8 or earlier

1. Stop MygramDB
2. Upgrade to v1.3.9
3. Restart MygramDB

No configuration changes required. This is a backward-compatible release.

### Recommended Actions

- Review binlog replication status after upgrade with `SYNC STATUS`
- Monitor memory usage to verify leak fixes
- If using GEOMETRY columns, verify data replication

---

## Known Issues

None.

---

## Migration Notes

No migration required. This is a backward-compatible release.

**Note for Operators:**

- The GTID handling improvements may cause a brief delay during initial sync as the system re-validates GTID state
- Memory usage should decrease after upgrade due to leak fixes
- If you were experiencing binlog replication issues (missing rows, thread termination), they should be resolved in this version
