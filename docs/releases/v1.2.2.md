# MygramDB v1.2.2 Release Notes

**Release Date:** 2025-11-20
**Type:** Patch Release (Critical Bug Fix)

---

## Overview

Version 1.2.2 is a critical patch release that fixes a Docker entrypoint script compatibility issue introduced in v1.2.1. Users who set the `NETWORK_ALLOW_CIDRS` environment variable in Docker environments will encounter a shell syntax error without this fix.

## What's Fixed

### Docker Entrypoint POSIX Compatibility

**Problem:** The Docker entrypoint script (introduced in v1.2.1) used bash-specific syntax (`<<<` here-string and array operations) while declaring `#!/bin/sh` as the shebang. In Docker containers, `/bin/sh` is typically linked to `dash` or another POSIX shell, not bash, causing the following error:

```
/usr/local/bin/entrypoint.sh: 150: Syntax error: redirection unexpected
Error: Process completed with exit code 2.
```

This error occurred when:
- Using the `NETWORK_ALLOW_CIDRS` environment variable
- Running in Docker environments (Alpine, Debian, Ubuntu containers)
- CI/CD builds using Docker

**Solution:** Rewrote the CIDR parsing logic using POSIX-compliant shell syntax:

**Before (bashism - line 150):**
```sh
IFS=',' read -ra CIDRS <<< "$NETWORK_ALLOW_CIDRS"
for cidr in "${CIDRS[@]}"; do
  cidr=$(echo "$cidr" | xargs)
  echo "    - \"$cidr\"" >> "$CONFIG_FILE"
done
```

**After (POSIX-compliant):**
```sh
echo "$NETWORK_ALLOW_CIDRS" | tr ',' '\n' | while read -r cidr; do
  cidr=$(echo "$cidr" | xargs)
  if [ -n "$cidr" ]; then
    echo "    - \"$cidr\"" >> "$CONFIG_FILE"
  fi
done
```

**Changes:**
- Replaced `<<<` here-string with `echo ... | tr ',' '\n'`
- Replaced bash array syntax with standard `while read` loop
- Added empty string check to skip blank entries
- Script now works in any POSIX-compliant shell (dash, ash, bash, etc.)

## Impact

### Who Should Upgrade

**Immediate upgrade required if:**
- ✅ Using Docker deployment
- ✅ Setting `NETWORK_ALLOW_CIDRS` environment variable
- ✅ Running v1.2.1 (affected version)

**Safe to upgrade (no impact if):**
- ✅ Using native binary installation (RPM, source build)
- ✅ Using custom configuration files (not relying on entrypoint.sh)
- ✅ Running v1.2.0 or earlier (upgrade recommended for Docker users)

## Migration Guide

### From v1.2.1 (Critical)

**No configuration changes required.** This is a drop-in replacement.

**Docker users:**
```bash
# Pull the fixed image
docker pull ghcr.io/libraz/mygram-db:v1.2.2

# Or update docker-compose.yml
services:
  mygramdb:
    image: ghcr.io/libraz/mygram-db:v1.2.2  # Changed from v1.2.1
```

**Test the fix:**
```bash
# This should now work without syntax errors
docker run --rm \
  -e MYSQL_HOST=testdb \
  -e TABLE_NAME=test \
  -e NETWORK_ALLOW_CIDRS=10.0.0.0/8,172.16.0.0/12 \
  ghcr.io/libraz/mygram-db:v1.2.2 test-config
```

### From v1.2.0

**All v1.2.1 improvements included:**
- `NETWORK_ALLOW_CIDRS` environment variable support (now working correctly)
- MySQL 8.4 compatibility
- RPM testing environment
- Aligned example configurations

**No breaking changes.** Safe to upgrade.

## Technical Details

### Root Cause Analysis

The bug was introduced in commit fixing issue #xxx (add NETWORK_ALLOW_CIDRS support):

1. **Intended behavior:** Parse comma-separated CIDR list from environment variable
2. **Implementation error:** Used bash-specific syntax in a `#!/bin/sh` script
3. **Why it wasn't caught:** Local development often uses `/bin/sh → bash` symlink, masking the issue
4. **Why CI caught it:** CI Docker containers use Alpine Linux where `/bin/sh → busybox ash`

### Shell Compatibility

| Shell | v1.2.1 (broken) | v1.2.2 (fixed) |
|-------|-----------------|----------------|
| bash  | ✅ Works | ✅ Works |
| dash  | ❌ Fails | ✅ Works |
| ash   | ❌ Fails | ✅ Works |
| zsh   | ❌ Fails | ✅ Works |

### Affected Code Path

The bug only triggered when:
1. `NETWORK_ALLOW_CIDRS` environment variable is set AND non-empty
2. Entrypoint script generates configuration file
3. CIDR list parsing logic executes (line 150)

**Not affected:**
- Using `-c config.yaml` with custom configuration
- Using `--help`, `--version` commands
- `NETWORK_ALLOW_CIDRS` unset or empty

## Known Issues

None.

## Contributors

- @libraz

## Links

- [Full Changelog](https://github.com/libraz/mygram-db/compare/v1.2.1...v1.2.2)
- [Docker Image](https://github.com/libraz/mygram-db/pkgs/container/mygram-db)
- [Installation Guide](../en/installation.md)
- [Docker Deployment Guide](../en/docker-deployment.md)

---

**Questions or Issues?**
Please open an issue on [GitHub Issues](https://github.com/libraz/mygram-db/issues)
