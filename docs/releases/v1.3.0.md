# MygramDB v1.3.0 Release Notes

**Release Date:** 2025-11-22
**Type:** Minor Release (Feature Addition)
**Previous Version:** v1.2.5

---

## ‚ö†Ô∏è BREAKING CHANGES - ACTION REQUIRED

### Dump File Incompatibility for DATETIME/DATE Columns

**Impact**: If your tables contain DATETIME or DATE filter columns, **dump files from v1.2.x are incompatible with v1.3.0**.

**Reason**: DATETIME/DATE values changed from string storage to epoch seconds (uint64_t) for performance and proper timezone support.

**Before v1.3.0:**

```cpp
FilterValue = std::string  // "2025-11-22 12:00:00"
```

**v1.3.0:**

```cpp
FilterValue = uint64_t     // 1732276800 (epoch seconds)
```

**Required Action Before Upgrade:**

If you use `/dump` endpoint or dump files:

1. **Create a new snapshot after upgrading** - do not attempt to load old dump files
2. **Verify filter columns** - check if any use `datetime`, `date`, or `time` types
3. **Plan downtime** - snapshot rebuild required during upgrade
4. **Backup data** - keep MySQL source data for rebuild

**Migration Steps:**

```bash
# 1. Backup current dump (optional, for reference only)
curl http://localhost:8080/articles/dump > backup_v1.2.5.dump

# 2. Upgrade to v1.3.0
docker pull ghcr.io/libraz/mygram-db:v1.3.0

# 3. Restart with empty data (will rebuild from MySQL)
rm -f /var/lib/mygramdb/dump.bin  # Remove old dump
systemctl restart mygramdb

# 4. Wait for snapshot to complete
# Check logs: "Snapshot completed"

# 5. Create new dump (new format)
curl http://localhost:8080/articles/dump > new_v1.3.0.dump
```

**Affected Scenarios:**

- ‚úÖ **Safe**: Tables with only `string`, `int`, `float` filter columns
- ‚ö†Ô∏è **Requires rebuild**: Tables with `datetime`, `date`, `time` filter columns
- ‚ö†Ô∏è **Requires rebuild**: Any saved dump files from v1.2.x with temporal columns

**Rollback Considerations:**

If you need to rollback from v1.3.0 to v1.2.5:

- Dump files created by v1.3.0 **cannot be loaded by v1.2.5**
- You must rebuild snapshot from MySQL on rollback

---

## Overview

Version 1.3.0 is a feature release that adds comprehensive support for temporal data types, including MySQL TIME columns, timezone-aware DATETIME/DATE handling, and enhanced sorting capabilities. This release enables MygramDB to handle time-series data, scheduling applications, and international datasets with proper timezone support.

**‚ö†Ô∏è Important**: This release changes the internal storage format for DATETIME/DATE/TIME filter columns from strings to epoch seconds. Dump files from v1.2.x containing these column types are incompatible and must be rebuilt.

## üöÄ New Features

### 1. MySQL TIME Type Support

**Complete support for MySQL TIME columns in filters and sorting:**

- TIME values stored as signed seconds from midnight (-3020399 to 3020399)
- Range: -838:59:59 to 838:59:59 (MySQL TIME spec)
- Full filter operator support: `=`, `!=`, `<`, `<=`, `>`, `>=`
- Proper sorting with ASC/DESC directives
- New `TimeValue` structure for type-safe TIME handling

**Use Cases:**

- Duration tracking (e.g., video length, session duration)
- Time-of-day scheduling (e.g., business hours, cron-like queries)
- Elapsed time calculations (supports negative values)

**Example Configuration:**

```yaml
tables:
  - name: "videos"
    filters:
      - column: "duration"
        type: "time"          # New: TIME type support
```

**Example Queries:**

```sql
-- Filter videos longer than 1 hour
SEARCH "tutorial" FILTER duration > "01:00:00"

-- Sort by duration (shortest first)
SEARCH "lecture" SORT duration ASC
```

**Implementation:**

- `src/storage/document_store.h`: Added `TimeValue` structure
- `src/mysql/rows_parser.cpp`: TIME value parsing from binlog
- `src/query/result_sorter.cpp`: TIME value sorting
- `tests/utils/datetime_converter_test.cpp`: 266 test cases

---

### 2. Timezone-Aware DATETIME/DATE Processing

**Comprehensive timezone support for DATETIME and DATE columns:**

- Configurable timezone for DATETIME/DATE interpretation
- Default: UTC (+00:00)
- Format: `[+-]HH:MM` (e.g., `+09:00` for JST, `-05:00` for EST)
- TIMESTAMP columns always stored as UTC (MySQL spec)
- Proper handling of DST boundaries and edge cases

**New Configuration Option:**

```yaml
mysql:
  datetime_timezone: "+09:00"  # Interpret DATETIME/DATE in JST
```

**Behavior:**

| Column Type | Timezone Handling | Example |
|-------------|-------------------|---------|
| DATETIME | Uses `datetime_timezone` | `2025-01-01 12:00:00` ‚Üí epoch with timezone offset |
| DATE | Uses `datetime_timezone` | `2025-01-01` ‚Üí epoch at midnight in configured timezone |
| TIMESTAMP | Always UTC | `2025-01-01 12:00:00` ‚Üí epoch in UTC (ignores `datetime_timezone`) |
| TIME | No timezone (duration) | `12:00:00` ‚Üí 43200 seconds |

**Use Cases:**

- Multi-region applications with localized timestamps
- International e-commerce (order timestamps in local time)
- Compliance requirements (GDPR, data residency)

**Implementation:**

- `src/utils/datetime_converter.h/cpp`: 664 lines of timezone conversion logic
- `src/config/config.h/cpp`: Configuration integration
- `src/mysql/binlog_filter_evaluator.cpp`: Timezone-aware filter evaluation
- `src/storage/snapshot_builder.cpp`: Snapshot with timezone support
- `tests/utils/datetime_converter_test.cpp`: Comprehensive timezone tests

**Important Notes:**

- ‚ö†Ô∏è Changing `datetime_timezone` requires server restart (not hot-reloadable)
- ‚ö†Ô∏è Existing data is re-interpreted with new timezone setting
- ‚ö†Ô∏è Use UTC (`+00:00`) unless you have specific timezone requirements

---

### 3. Bug Fix: Primary Key Column Name Sorting

**Fixed:** Primary key column name sorting (`SORT id ASC/DESC`) now works as documented.

**Background:** Documentation has always specified that both full syntax (`SORT id DESC`) and shorthand syntax (`SORT DESC`) should work for primary key sorting, but only the shorthand syntax was functional before v1.3.0.

**Before v1.3.0 (Bug):** Only shorthand syntax worked

```sql
SORT ASC       # ‚úÖ Worked (shorthand - primary key ascending)
SORT DESC      # ‚úÖ Worked (shorthand - primary key descending)
SORT id ASC    # ‚ùå Did NOT work (documented but broken)
SORT id DESC   # ‚ùå Did NOT work (documented but broken)
```

**v1.3.0 (Fixed):** Full syntax now works as documented

```yaml
# Configuration
tables:
  - name: "articles"
    primary_key: "id"  # Primary key column name
```

```sql
# Both syntaxes now work correctly
SORT id ASC    # ‚úÖ Now works (explicit primary key column name)
SORT id DESC   # ‚úÖ Now works (explicit primary key column name)
SORT ASC       # ‚úÖ Still works (shorthand, backward compatible)
SORT DESC      # ‚úÖ Still works (shorthand, backward compatible)
```

**Impact:**

- Fixes documented behavior that was not working
- No breaking changes - shorthand syntax still works
- Makes API consistent with documentation
- Aligns with SQL conventions (explicit column names)

**NULL Handling Improvement:**

Along with fixing the primary key column name bug, NULL value handling in ASC/DESC sorting was also improved:

```sql
SORT created_at ASC    # NULL values first, then oldest to newest
SORT created_at DESC   # Newest to oldest, then NULL values last
```

- ASC: NULL values sort first (MySQL semantics)
- DESC: NULL values sort last (MySQL semantics)
- Consistent with SQL ORDER BY behavior

**Implementation:**

- `src/query/result_sorter.cpp:79-103`: Primary key column name detection and handling
- `src/server/handlers/search_handler.cpp`: Pass primary key column name to sorter
- `tests/query/result_sorter_asc_desc_test.cpp`: 314 test cases covering all scenarios

---

### 4. Query Parameter Support in Snapshot API

**Enable filtering and sorting during snapshot creation:**

**New HTTP Endpoints:**

```bash
# Snapshot with filters
GET /articles/snapshot?filter=status:published&filter=category:tech

# Snapshot with sorting
GET /articles/snapshot?sort=created_at&order=desc

# Snapshot with filters and sorting
GET /articles/snapshot?filter=status:published&sort=priority&order=desc
```

**Use Cases:**

- Export subsets of data (e.g., published articles only)
- Create sorted dumps for data migration
- Backup specific categories or time ranges

**Implementation:**

- `src/storage/snapshot_builder.cpp`: Query parameter integration
- `src/server/http_server.cpp`: Snapshot endpoint enhancement
- `tests/storage/snapshot_builder_query_test.cpp`: 252 test cases

---

## üîß Configuration Changes

### New Configuration Options

```yaml
mysql:
  # Timezone for DATETIME/DATE columns (default: "+00:00" UTC)
  # Format: [+-]HH:MM (e.g., "+09:00" for JST, "-05:00" for EST)
  # TIMESTAMP columns are always UTC (not affected by this setting)
  # ‚ö†Ô∏è Requires restart when changed (not hot-reloadable)
  datetime_timezone: "+00:00"
```

### Hot Reload Status

| Setting | Hot Reloadable? | Notes |
|---------|----------------|-------|
| `datetime_timezone` | ‚ùå No (requires restart) | Affects binlog processing and snapshot building |
| `logging.level` | ‚úÖ Yes | Can be changed via SIGHUP |
| `logging.format` | ‚úÖ Yes | Can be changed via SIGHUP |

**Why Not Hot-Reloadable?**

`datetime_timezone` is set during `BinlogReader` and `SnapshotBuilder` initialization and affects:

- Binlog event parsing (row data conversion)
- Filter evaluation (datetime comparisons)
- Snapshot building (initial data load)

Changing timezone mid-operation would cause data inconsistency.

---

## üìù Documentation Updates

### New Documentation Sections

1. **TIME Type Support** (`docs/en/configuration.md`, `docs/ja/configuration.md`)
   - TIME column configuration
   - Filter operators for TIME values
   - Sorting TIME columns

2. **Timezone Configuration** (All configuration docs)
   - `datetime_timezone` setting
   - DATETIME vs TIMESTAMP behavior
   - Timezone format specification
   - Hot reload restrictions

3. **Enhanced Sorting** (Search API docs)
   - Primary key column name sorting
   - ASC/DESC examples
   - NULL value handling

### Updated Configuration Examples

- `examples/config.yaml`: Added `datetime_timezone` with detailed comments
- `examples/config.json`: Added `datetime_timezone`
- `examples/config-minimal.yaml`: Added `datetime_timezone` with usage note
- `examples/config-minimal.json`: Added `datetime_timezone`

---

## üß™ Testing

### New Test Suites

1. **DateTime Converter Tests** (`tests/utils/datetime_converter_test.cpp`)
   - 266 test cases
   - Timezone parsing (valid/invalid formats)
   - DATETIME/DATE/TIMESTAMP conversion
   - TIME value parsing (positive/negative/edge cases)
   - Edge cases: leap years, DST boundaries, overflow

2. **Result Sorter ASC/DESC Tests** (`tests/query/result_sorter_asc_desc_test.cpp`)
   - 314 test cases
   - ASC/DESC sorting for all data types
   - Primary key column name sorting
   - NULL value handling in both directions
   - TIME type sorting (positive/negative values)

3. **Snapshot Builder Query Tests** (`tests/storage/snapshot_builder_query_test.cpp`)
   - 252 test cases
   - Filter application during snapshot
   - Sorting during snapshot
   - Combined filter+sort scenarios

### Test Coverage Summary

- **Total New Tests**: 832 test cases
- **Files Changed**: 57 files (+2,621 lines, -176 lines)
- **Test Files Added**: 3 new test files
- **Coverage**: All new features have comprehensive test coverage

---

## üîÑ Migration Guide

### From v1.2.5 to v1.3.0

**No breaking changes.** This is a backward-compatible feature addition.

#### 1. Timezone Configuration (Optional)

**If you use DATETIME or DATE columns:**

```yaml
mysql:
  # Add timezone configuration (default is UTC)
  datetime_timezone: "+09:00"  # Example: Japan Standard Time
```

**Default Behavior (No Configuration Change):**

- All DATETIME/DATE values interpreted as UTC (+00:00)
- TIMESTAMP values always UTC (MySQL spec)
- No change to existing behavior

**After Adding Timezone:**

- ‚ö†Ô∏è Server restart required
- Existing filter values are re-interpreted in new timezone
- Test thoroughly before production deployment

#### 2. Using TIME Type (Optional)

**Add TIME filters to table configuration:**

```yaml
tables:
  - name: "events"
    filters:
      - column: "duration"
        type: "time"  # New type
```

**Restart MygramDB** to pick up new filter configuration.

#### 3. Enhanced Sorting (No Configuration Required)

**Already works with existing configurations:**

```bash
# Primary key sorting (now supports column name)
curl "http://localhost:8080/articles?q=search&sort=id&order=desc"

# Explicit ASC/DESC
curl "http://localhost:8080/articles?q=search&sort=created_at&order=asc"
```

### Upgrade Steps

**Docker users:**

```bash
# Pull new image
docker pull ghcr.io/libraz/mygram-db:v1.3.0

# Update docker-compose.yml
services:
  mygramdb:
    image: ghcr.io/libraz/mygram-db:v1.3.0
    environment:
      # Optional: Set timezone via environment variable
      DATETIME_TIMEZONE: "+09:00"
```

**RPM users:**

```bash
# Download and install
sudo rpm -Uvh mygramdb-1.3.0-1.el9.x86_64.rpm

# Update configuration if needed
sudo vim /etc/mygramdb/config.yaml
# Add: datetime_timezone: "+09:00"

# Restart service
sudo systemctl restart mygramdb
```

**Source build:**

```bash
git checkout v1.3.0
cmake -B build -DCMAKE_BUILD_TYPE=Release
cmake --build build --parallel
sudo systemctl restart mygramdb
```

### Rollback Procedure

If issues arise:

```bash
# Docker
docker pull ghcr.io/libraz/mygram-db:v1.2.5

# RPM
sudo rpm -Uvh --oldpackage mygramdb-1.2.5-1.el9.x86_64.rpm
```

---

## üêõ Bug Fixes

### Primary Key Column Name Sorting (Critical)

**Fixed:** `SORT id ASC` and `SORT id DESC` now work as documented.

**Issue:** Documentation (docs/en/query_syntax.md:310-314) has always stated that full syntax (`SORT <primary_key_column> ASC/DESC`) should work, but it was non-functional. Only the shorthand syntax (`SORT ASC/DESC`) worked.

**Root Cause:** `result_sorter.cpp` only checked for empty column names to trigger primary key sorting path. When users specified the actual primary key column name (e.g., `id`), it was treated as a filter column lookup, which would fail if `id` was not configured as a filter.

**Fix:** Enhanced `GetSortKey()` to detect when the sort column name matches the primary key column name and route to the optimized primary key path (`src/query/result_sorter.cpp:79-103`).

**Impact:** High - fixes a long-standing documentation vs. implementation mismatch that would have confused users following the documented examples.

**Files Changed:**

- `src/query/result_sorter.cpp`: Primary key column name detection
- `src/server/handlers/search_handler.cpp`: Pass primary key column name to sorter
- `tests/query/result_sorter_asc_desc_test.cpp`: 314 comprehensive test cases

### Sort Key Generation for Filter Columns

**Fixed:** When sorting by a column that exists as both primary key and filter column, the filter value now takes precedence (intended behavior).

**Impact:** Minimal - affects only tables where primary key column name is also configured as a filter column.

---

## üîí Security Considerations

### Timezone Configuration

**Recommendation:** Use UTC (`+00:00`) unless you have specific business requirements for local time interpretation.

**Risks of Non-UTC Timezones:**

- DST transitions may cause ambiguous timestamps
- Different servers with different timezone settings may interpret data differently
- Cross-timezone queries become more complex

**Best Practice:**

- Store all timestamps in UTC in MySQL
- Use TIMESTAMP instead of DATETIME when possible
- Only use `datetime_timezone` for legacy databases with local time DATETIME columns

---

## üìä Performance Impact

### Positive Impact

- **Schwartzian Transform for TIME:** TIME sorting uses precomputed keys (O(N) lookups, O(N log N) sort)
- **Optimized Primary Key Path:** Primary key column name sorting uses same optimized path as empty string

### Neutral Impact

- **Timezone Conversion:** One-time conversion during binlog event processing (minimal overhead)
- **DateTime Processor:** Cached per-connection (no per-event overhead)

### Memory Usage

- **DateTime Converter Module:** ~664 lines of code (~15 KB additional binary size)
- **TimeValue Storage:** 8 bytes per TIME filter value (same as int64_t)

---

## üåê Internationalization

### Supported Timezones

All standard UTC offsets from **-12:00 to +14:00** in 15-minute increments:

```text
-12:00, -11:00, -10:00, -09:30, -09:00, -08:00, -07:00, -06:00,
-05:00, -04:00, -03:30, -03:00, -02:00, -01:00,
+00:00 (UTC),
+01:00, +02:00, +03:00, +03:30, +04:00, +04:30, +05:00, +05:30,
+05:45, +06:00, +06:30, +07:00, +08:00, +08:45, +09:00, +09:30,
+10:00, +10:30, +11:00, +12:00, +12:45, +13:00, +14:00
```

**Notable Examples:**

- JST (Japan): `+09:00`
- EST (US Eastern): `-05:00`
- IST (India): `+05:30`
- ACST (Australia Central): `+09:30`
- Nepal: `+05:45`

---

## üìã Known Issues

**None identified in this release.**

---

## üöÄ Upgrade Recommendation

### ‚ö†Ô∏è CRITICAL: Read "BREAKING CHANGES" section before upgrading

**Priority: High** (with planning required) for:

- Applications using DATETIME/DATE columns in filters or sorting
  - **Action**: Plan downtime for snapshot rebuild
  - **Action**: Delete old dump files before upgrade
  - **Action**: Verify timezone configuration (`datetime_timezone`)
- Multi-region deployments requiring local timezone interpretation
  - **Action**: Configure appropriate timezone offset
- Applications with TIME columns (duration, time-of-day)
  - **Action**: Rebuild snapshot from MySQL

**Priority: Low** for:

- Applications using only TIMESTAMP columns (already UTC)
  - **No action required** - TIMESTAMP storage format unchanged
- Applications using only `string`, `int`, `float` filter columns
  - **No action required** - no dump format changes
- Single-region deployments in UTC with no temporal columns
  - **No action required** - backward compatible

---

## üìà Statistics

### Code Changes

- **Files Changed**: 57
- **Insertions**: +2,621 lines
- **Deletions**: -176 lines
- **Net Change**: +2,445 lines

### Module Breakdown

| Module | Files | Insertions | Deletions | Description |
|--------|-------|-----------|-----------|-------------|
| Utils | 2 | +664 | 0 | DateTime converter implementation |
| Tests | 3 | +832 | 0 | New test suites |
| Query | 2 | +125 | -22 | Enhanced sorting |
| MySQL | 6 | +140 | -15 | TIME parsing and timezone support |
| Storage | 4 | +130 | -23 | Snapshot query support, TIME values |
| Config | 3 | +23 | -2 | Timezone configuration |
| Server | 3 | +60 | -3 | Primary key column name handling |
| Docs | 6 | +48 | -8 | Configuration and API docs |
| Examples | 4 | +8 | 0 | Minimal config updates |
| CI/Docker | 3 | +33 | -3 | Docker deployment updates |

---

## üôè Acknowledgments

This release represents a significant enhancement to MygramDB's temporal data handling:

- **Type Safety**: TimeValue structure for compile-time type checking
- **Comprehensive Testing**: 832 new test cases for edge cases and correctness
- **Documentation**: Bilingual (EN/JA) updates across all docs
- **Backward Compatibility**: Zero breaking changes

Special thanks to the Claude Code specialized agents that ensured correct timezone arithmetic and comprehensive test coverage.

---

## üîó Links

- **Full Changelog**: [v1.2.5...v1.3.0](https://github.com/libraz/mygram-db/compare/v1.2.5...v1.3.0)
- **Docker Image**: [ghcr.io/libraz/mygram-db](https://github.com/libraz/mygram-db/pkgs/container/mygram-db)
- **Configuration Reference**: [docs/en/configuration.md](../en/configuration.md)
- **Search API Reference**: [docs/en/api.md](../en/api.md)

---

## üìß Support

Questions or Issues?

- GitHub Issues: <https://github.com/libraz/mygram-db/issues>
- Documentation: `docs/` directory
- Discussions: <https://github.com/libraz/mygram-db/discussions>

---

Recommended Version: v1.3.0

Release Tag: `git tag -a v1.3.0 -m "MygramDB v1.3.0: Temporal data types and timezone support"`
