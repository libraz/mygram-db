# MygramDB v1.3.3 Release Notes

**Release Date:** 2025-11-25
**Type:** Patch Release (Bug Fixes)
**Previous Version:** v1.3.2

---

## Overview

Version 1.3.3 fixes critical bugs in MySQL binlog datetime parsing and server_id configuration. These bugs caused DATETIME columns to be parsed as invalid dates (e.g., `2025-11-25` became `0110-00-25`) and replication conflicts when multiple MygramDB instances connected to the same MySQL server.

---

## Bug Fixes

### 1. DATETIME2 Parsing Produces Invalid Dates

**Severity:** Critical - Data Corruption

**Problem:** DATETIME2 values from MySQL binlog were parsed incorrectly, producing dates like `0110-00-25 14:30:00` instead of `2025-11-25 14:30:00`. Symptoms included `datetime_conversion_failed` warnings in logs with invalid dates (e.g., month=14, month=15).

**Symptoms:**
```
[warn] {"event":"datetime_conversion_failed","table":"threads","datetime":"0102-07-05 08:39:04","reason":"Failed to parse datetime string"}
[warn] {"event":"datetime_conversion_failed","table":"threads","datetime":"0108-14-03 17:43:48","reason":"Failed to parse datetime string"}
```

**Root Cause:**

MySQL DATETIME2 uses a packed binary format (see `mysql-8.4.7/mysys/my_time.cc`):
1. 5 bytes stored as big-endian with `DATETIMEF_INT_OFS = 0x8000000000LL` offset
2. Year and month calculated as `year = ym / 13`, `month = ym % 13`

The original implementation:
- Missing offset subtraction
- Used bitwise extraction (`ym >> 4`, `ym & 0x0F`) instead of division/modulo

**Fix:**
```cpp
// Before (wrong)
int64_t ym = ymd >> 5;
unsigned int month = (ym >> 4) & 0x0F;
unsigned int year = static_cast<unsigned int>(ym >> 8);

// After (correct)
constexpr int64_t kDatetimeIntOfs = 0x8000000000LL;
int64_t intpart = static_cast<int64_t>(packed) - kDatetimeIntOfs;
int64_t ym = ymd >> 5;
unsigned int month = ym % 13;
unsigned int year = static_cast<unsigned int>(ym / 13);
```

**Files Changed:**
- `src/mysql/rows_parser.cpp` - DATETIME2 parsing (case 18)

---

### 2. server_id Not Passed to MySQL Replication

**Severity:** Critical - Replication Conflicts

**Problem:** The `server_id` from configuration was ignored; instead, a hardcoded value `1001` was always used. This caused replication to silently stop when multiple MygramDB instances connected to the same MySQL server (MySQL detects duplicate server_id and disconnects one client).

**Symptoms:**
- Replication stops after ~5 minutes without error logs
- Works initially, then mysteriously stops
- Affects production deployments with multiple instances

**Root Cause:**

In `src/mysql/binlog_reader.cpp:358`:
```cpp
// Before (hardcoded)
rpl.server_id = 1001;

// After (uses config)
rpl.server_id = config_.server_id;
```

The `server_id` field was not included in `BinlogReader::Config` struct.

**Fix:**
- Added `server_id` field to `BinlogReader::Config` struct
- Pass `server_id` from `ServerOrchestrator` to `BinlogReader`
- Added validation to reject `server_id = 0` with clear error message
- Added `server_id` to startup log

**Files Changed:**
- `src/mysql/binlog_reader.h` - Add `server_id` to Config struct
- `src/mysql/binlog_reader.cpp` - Use `config_.server_id`, add validation
- `src/app/server_orchestrator.cpp` - Pass `server_id` to binlog config

---

### 3. TIME2 Type Not Implemented

**Severity:** Medium - Missing Functionality

**Problem:** MySQL TIME2 type (type 19) was not implemented, causing `[UNSUPPORTED_TYPE:19]` in parsed values.

**Fix:** Implemented TIME2 parsing with:
- `TIMEF_INT_OFS = 0x800000` offset subtraction
- 3 bytes big-endian format
- Fractional seconds support (precision 0-6)
- Negative time handling

**Files Changed:**
- `src/mysql/rows_parser.cpp` - TIME2 parsing (case 19)

---

### 4. TIMESTAMP2 Big-Endian Handling

**Severity:** Low - Incorrect Values

**Problem:** TIMESTAMP2 was sharing code path with TIMESTAMP, but they have different byte orders:
- TIMESTAMP: 4 bytes little-endian
- TIMESTAMP2: 4 bytes big-endian + fractional seconds

**Fix:** Separated TIMESTAMP2 (case 17) from TIMESTAMP (case 7) with correct big-endian handling.

**Files Changed:**
- `src/mysql/rows_parser.cpp` - TIMESTAMP2 parsing (case 17)

---

## Testing

### New Tests Added

**DateTimeParsingTest suite** (14 tests):
- `Datetime2BasicParsing` - Basic DATETIME2 parsing
- `Datetime2YearBoundary` - Y2K edge case (2000-01-01)
- `Datetime2MaxTimeValues` - Max time (23:59:59)
- `Datetime2WithMicroseconds` - Precision 6 fractional seconds
- `Datetime2WithMilliseconds` - Precision 3 fractional seconds
- `Time2BasicParsing` - Basic TIME2 parsing
- `Time2WithMicroseconds` - TIME2 with fractional seconds
- `Time2MaxHour` - MySQL max TIME (838:59:59)
- `TimeOldFormat` - Legacy TIME format
- `Timestamp2BasicParsing` - TIMESTAMP2 basic parsing
- `Timestamp2WithMicroseconds` - TIMESTAMP2 with fractional seconds
- `DateParsing` - DATE type parsing
- `DateLeapYear` - Leap year edge case (2024-02-29)
- `Datetime2BugReproduction` - Regression test for the original bug

**BinlogReaderResourceTest** (1 test):
- `StartFailsWithZeroServerId` - Validates server_id=0 rejection

### Test Results

- **Total tests:** 1,428
- **Passed:** 1,428 (100%)
- **New tests added:** 15

---

## Files Changed

| File | Changes |
|------|---------|
| `src/mysql/rows_parser.cpp` | DATETIME2, TIME2, TIMESTAMP2 parsing fixes |
| `src/mysql/binlog_reader.h` | Add `server_id` to Config struct |
| `src/mysql/binlog_reader.cpp` | Use config server_id, add validation |
| `src/app/server_orchestrator.cpp` | Pass server_id to binlog config |
| `tests/mysql/rows_parser_test.cpp` | 14 new datetime parsing tests |
| `tests/mysql/binlog_reader_resource_test.cpp` | server_id validation test |
| `tests/mysql/binlog_reader_*.cpp` | Update test fixtures with server_id |
| `tests/integration/server/multi_table_test.cpp` | Update test fixtures |

---

## Upgrade Instructions

### From v1.3.2 or earlier

1. Stop MygramDB
2. Upgrade to v1.3.3
3. Restart MygramDB
4. (Optional) Run `SYNC <table>` to refresh datetime values if they were corrupted

### Verifying the Fix

After upgrade, check logs for absence of `datetime_conversion_failed` warnings:
```bash
grep "datetime_conversion_failed" /var/log/mygramdb.log
```

If datetime values were previously corrupted, run SYNC to refresh from MySQL.

---

## Known Issues

None.

---

## Migration Notes

No migration required. This is a bug fix release with no breaking changes.
