# MygramDB v1.3.8 Release Notes

**Release Date:** 2025-12-21
**Type:** Bug Fix Release
**Previous Version:** v1.3.7

---

## Overview

Version 1.3.8 fixes TCP protocol line ending issues that could cause client timeouts when receiving multi-line responses. This release also adds the `mygramclient_send_command` function to the C API for sending arbitrary commands.

**Highlights:**

- **TCP Protocol Fix** - Consistent CRLF line endings across all multi-line responses
- **C API Enhancement** - New `mygramclient_send_command` function for generic command execution

---

## Bug Fixes

### 1. TCP Protocol CRLF Line Endings

**Type:** Bug Fix
**Severity:** Medium

Fix inconsistent line endings in TCP protocol responses that could cause client timeouts when reading multi-line responses.

**Root Cause:** Several response formatters were using LF (`\n`) instead of CRLF (`\r\n`) for line endings. When clients expected CRLF-terminated lines (per TCP text protocol conventions), they would wait indefinitely for the `\r` character, causing timeouts.

**Affected Commands:**

- `CONFIG HELP` - Help text output
- `CONFIG SHOW` - Configuration display
- `CONFIG VERIFY` - Validation results
- `CONFIG` - Full configuration display
- `SYNC STATUS` - Sync operation status

**Solution:**

- Update all response formatters to use CRLF (`\r\n`) line endings
- Ensure responses don't end with trailing CRLF (SendResponse adds final CRLF)
- Add comprehensive tests to verify CRLF compliance

**Files Changed:**

- `src/config/config_help.cpp` - JsonToYaml and format functions
- `src/server/handlers/admin_handler.cpp` - CONFIG command handlers
- `src/server/response_formatter.cpp` - FormatConfigResponse
- `src/server/sync_operation_manager.cpp` - GetSyncStatus

---

## New Features

### 1. C API: mygramclient_send_command

**Type:** Feature

Add generic command sending function to the C API for sending arbitrary commands to the server.

**Function Signature:**

```c
int mygramclient_send_command(
    MygramClient_C* client,
    const char* command,
    char** response
);
```

**Parameters:**

| Parameter | Description |
|-----------|-------------|
| `client` | Client handle |
| `command` | Command string (without `\r\n` terminator) |
| `response` | Output response string (caller must free with `mygramclient_free_string`) |

**Returns:** 0 on success, -1 on error

**Use Cases:**

- Custom commands not covered by dedicated API functions
- Future protocol extensions
- Generic command execution from C/C++ applications

**Files Changed:**

- `src/client/mygramclient_c.cpp` - Implementation
- `src/client/mygramclient_c.h` - Header with documentation

---

## Testing

### New Tests

- `CApiSendCommand` - Tests `mygramclient_send_command` with COUNT, INFO, and invalid commands
- `CApiSendCommandErrors` - Tests error handling (NULL client, not connected, NULL parameters)
- `ConfigHelpUsesCRLFLineEndings` - Verifies CONFIG HELP responses use CRLF
- `ConfigShowUsesCRLFLineEndings` - Verifies CONFIG SHOW responses use CRLF
- `ConfigHelpSpecificPathUsesCRLFLineEndings` - Verifies specific path help uses CRLF
- `ConfigShowSpecificSectionUsesCRLFLineEndings` - Verifies section display uses CRLF
- `FormatConfigResponseUsesCRLFLineEndings` - Verifies ResponseFormatter CRLF compliance
- `GetSyncStatusUsesCRLFLineEndings` - Verifies SYNC STATUS uses CRLF

### Test Infrastructure

- Add bare LF detection in test assertions to catch mixed line ending issues
- Add trailing CRLF validation (response should not end with CRLF since SendResponse adds it)

---

## Files Changed Summary

| Category | Files |
|----------|-------|
| Bug Fixes | config_help.cpp, admin_handler.cpp, response_formatter.cpp, sync_operation_manager.cpp |
| New Features | mygramclient_c.cpp, mygramclient_c.h |
| Tests | mygramclient_test.cpp, config_handler_test.cpp, response_formatter_test.cpp, sync_operation_manager_deadlock_test.cpp |

**Total: 10 files changed, 344 insertions, 67 deletions**

---

## Upgrade Instructions

### From v1.3.7 or earlier

1. Stop MygramDB
2. Upgrade to v1.3.8
3. Restart MygramDB

No configuration changes required. This is a backward-compatible release.

---

## Known Issues

None.

---

## Migration Notes

No migration required. This is a backward-compatible release.

**Note for Client Developers:** If your client implementation was working around the mixed line ending issue, you may now be able to simplify your response parsing logic to expect consistent CRLF line endings.

