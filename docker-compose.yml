version: '3.8'

services:
  mysql:
    image: mysql:8.4
    container_name: ${COMPOSE_PROJECT_NAME:-mygramdb}_mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root_secure_password}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-mydb}
      MYSQL_USER: ${MYSQL_USER:-repl_user}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-your_secure_password}
    command:
      - --server-id=1
      - --log-bin=mysql-bin
      - --gtid-mode=ON
      - --enforce-gtid-consistency=ON
      - --binlog-format=ROW
      - --binlog-row-image=FULL
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --default-authentication-plugin=mysql_native_password
    ports:
      - "${MYSQL_PORT:-3306}:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./support/docker/mysql/init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD:-root_secure_password}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - mygramdb_network

  mygramdb:
    image: mygramdb:${MYGRAMDB_VERSION:-latest}
    container_name: ${COMPOSE_PROJECT_NAME:-mygramdb}_app
    restart: unless-stopped
    build:
      context: .
      dockerfile: Dockerfile
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      # MySQL Configuration
      MYSQL_HOST: ${MYSQL_HOST:-mysql}
      MYSQL_PORT: ${MYSQL_PORT:-3306}
      MYSQL_USER: ${MYSQL_USER:-repl_user}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-your_secure_password}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-mydb}
      MYSQL_USE_GTID: ${MYSQL_USE_GTID:-true}
      MYSQL_CONNECT_TIMEOUT_MS: ${MYSQL_CONNECT_TIMEOUT_MS:-3000}

      # Table Configuration
      TABLE_NAME: ${TABLE_NAME:-articles}
      TABLE_PRIMARY_KEY: ${TABLE_PRIMARY_KEY:-id}
      TABLE_TEXT_COLUMN: ${TABLE_TEXT_COLUMN:-content}
      TABLE_NGRAM_SIZE: ${TABLE_NGRAM_SIZE:-2}
      TABLE_KANJI_NGRAM_SIZE: ${TABLE_KANJI_NGRAM_SIZE:-1}

      # Replication Configuration
      REPLICATION_ENABLE: ${REPLICATION_ENABLE:-true}
      REPLICATION_SERVER_ID: ${REPLICATION_SERVER_ID:-12345}
      REPLICATION_START_FROM: ${REPLICATION_START_FROM:-snapshot}

      # Build Configuration
      BUILD_BATCH_SIZE: ${BUILD_BATCH_SIZE:-5000}
      BUILD_PARALLELISM: ${BUILD_PARALLELISM:-2}

      # Memory Management
      MEMORY_HARD_LIMIT_MB: ${MEMORY_HARD_LIMIT_MB:-8192}
      MEMORY_SOFT_TARGET_MB: ${MEMORY_SOFT_TARGET_MB:-4096}
      MEMORY_NORMALIZE_NFKC: ${MEMORY_NORMALIZE_NFKC:-true}
      MEMORY_NORMALIZE_WIDTH: ${MEMORY_NORMALIZE_WIDTH:-narrow}
      MEMORY_NORMALIZE_LOWER: ${MEMORY_NORMALIZE_LOWER:-false}

      # Snapshot Configuration
      SNAPSHOT_DIR: ${SNAPSHOT_DIR:-/var/lib/mygramdb/snapshots}
      SNAPSHOT_INTERVAL_SEC: ${SNAPSHOT_INTERVAL_SEC:-600}
      SNAPSHOT_RETAIN: ${SNAPSHOT_RETAIN:-3}

      # API Server Configuration
      API_BIND: ${API_BIND:-0.0.0.0}
      API_PORT: ${API_PORT:-11016}

      # Logging Configuration
      LOG_LEVEL: ${LOG_LEVEL:-info}
      LOG_FORMAT: ${LOG_FORMAT:-json}
    ports:
      - "${API_PORT:-11016}:${API_PORT:-11016}"
    volumes:
      - mygramdb_data:/var/lib/mygramdb
    healthcheck:
      test: ["CMD", "pgrep", "-x", "mygramdb"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    networks:
      - mygramdb_network

volumes:
  mysql_data:
    driver: local
  mygramdb_data:
    driver: local

networks:
  mygramdb_network:
    driver: bridge
