name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Detect which files have changed to skip unnecessary jobs
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    outputs:
      src: ${{ steps.filter.outputs.src }}
      tests: ${{ steps.filter.outputs.tests }}
      docker: ${{ steps.filter.outputs.docker }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            src:
              - 'src/**'
              - 'CMakeLists.txt'
              - 'third_party/**'
              - 'Makefile'
            tests:
              - 'tests/**'
            docker:
              - 'src/**'
              - 'CMakeLists.txt'
              - 'third_party/**'
              - 'Makefile'
              - 'Dockerfile'
              - 'support/docker/**'
              - 'examples/**'
              - '.dockerignore'

  linux-test-and-coverage:
    name: Linux Build, Test and Coverage
    needs: changes
    # Always run on main branch pushes, skip on PRs only if no relevant changes
    if: github.event_name == 'push' || needs.changes.outputs.src == 'true' || needs.changes.outputs.tests == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true  # Stop all jobs on first failure

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Cache CMake dependencies
      uses: actions/cache@v4
      with:
        path: build/_deps
        key: ${{ runner.os }}-cmake-deps-${{ hashFiles('CMakeLists.txt', 'third_party/**') }}
        restore-keys: |
          ${{ runner.os }}-cmake-deps-

    - name: Cache ccache
      uses: actions/cache@v4
      with:
        path: ~/.cache/ccache
        key: ${{ runner.os }}-ccache-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-ccache-

    - name: Cache LLVM installation
      id: cache-llvm
      uses: actions/cache@v4
      with:
        path: |
          /usr/lib/llvm-18
          /usr/bin/clang-format-18
          /usr/bin/clang-tidy-18
        key: ${{ runner.os }}-llvm-18

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          build-essential \
          libmysqlclient-dev \
          libicu-dev \
          libreadline-dev \
          pkg-config \
          lcov \
          ccache

    - name: Install LLVM/Clang 18
      if: steps.cache-llvm.outputs.cache-hit != 'true'
      run: |
        wget https://apt.llvm.org/llvm.sh
        chmod +x llvm.sh
        sudo ./llvm.sh 18
        sudo apt-get install -y clang-format-18 clang-tidy-18

    - name: Setup LLVM alternatives
      run: |
        sudo update-alternatives --install /usr/bin/clang-format clang-format /usr/bin/clang-format-18 100
        sudo update-alternatives --install /usr/bin/clang-tidy clang-tidy /usr/bin/clang-tidy-18 100

    # Note: format-check and clang-tidy are only run on develop branch (see develop-ci.yml)
    # Main branch focuses on functionality tests and coverage only

    - name: Setup ccache
      run: |
        ccache --set-config=max_size=500M
        ccache --zero-stats

    - name: Configure CMake with coverage
      env:
        CC: ccache gcc
        CXX: ccache g++
      run: |
        mkdir -p build
        cd build
        cmake -DCMAKE_BUILD_TYPE=Debug \
              -DBUILD_TESTS=ON \
              -DENABLE_COVERAGE=ON \
              -DUSE_ICU=ON \
              -DUSE_MYSQL=ON \
              -DMYGRAMDB_PORTABLE_BUILD=ON \
              ..

    - name: Build
      run: |
        cd build
        make -j$(nproc)

    - name: Show ccache statistics
      run: ccache --show-stats

    # Note: clang-tidy is only run on develop branch (see develop-ci.yml)
    # Main branch focuses on tests and coverage only

    - name: Run tests with coverage
      run: |
        cd build
        make coverage

    - name: Test binary
      run: |
        # Test help
        ./build/bin/mygramdb --help

        # Test version
        ./build/bin/mygramdb --version

        # Test config validation
        ./build/bin/mygramdb -t examples/config-minimal.yaml

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: ./build/coverage/coverage_filtered.info
        flags: unittests
        name: codecov-mygramdb
        fail_ci_if_error: false
        verbose: true

    - name: Upload coverage HTML report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: build/coverage/html/

    - name: Upload build artifacts
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-linux
        path: |
          build/CMakeFiles/*.log
          build/Testing/Temporary/

  # macOS build and test is disabled since the development environment is macOS
  # and local testing is sufficient. CI focuses on Linux compatibility.
  # Uncomment this job if cross-platform testing on macOS is needed.
  #
  # build-and-test-macos:
  #   name: Build and Test (macOS)
  #   needs: [changes, linux-test-and-coverage]
  #   # Skip macOS tests on main push due to timeout instability
  #   # macOS tests run on develop branch and PRs
  #   if: |
  #     github.event_name == 'pull_request' &&
  #     (needs.changes.outputs.src == 'true' || needs.changes.outputs.tests == 'true')
  #   runs-on: macos-latest
  #   strategy:
  #     fail-fast: true  # Stop all jobs on first failure
  #   #   steps:
  #   - name: Checkout code
  #     uses: actions/checkout@v4
  #   #   - name: Cache CMake dependencies
  #     uses: actions/cache@v4
  #     with:
  #       path: build/_deps
  #       key: ${{ runner.os }}-cmake-deps-${{ hashFiles('CMakeLists.txt', 'third_party/**') }}
  #       restore-keys: |
  #         ${{ runner.os }}-cmake-deps-
  #   #   - name: Cache ccache
  #     uses: actions/cache@v4
  #     with:
  #       path: ~/Library/Caches/ccache
  #       key: ${{ runner.os }}-ccache-${{ github.sha }}
  #       restore-keys: |
  #         ${{ runner.os }}-ccache-
  #   #   - name: Cache Homebrew packages
  #     uses: actions/cache@v4
  #     with:
  #       path: ~/Library/Caches/Homebrew
  #       key: ${{ runner.os }}-brew-${{ hashFiles('.github/workflows/ci.yml') }}
  #       restore-keys: |
  #         ${{ runner.os }}-brew-
  #   #   - name: Install dependencies (macOS)
  #     run: |
  #       brew install \
  #         cmake \
  #         mysql-client@8.4 \
  #         icu4c \
  #         readline \
  #         pkg-config \
  #         ccache
  #   #   - name: Setup ccache
  #     run: |
  #       ccache --set-config=max_size=500M
  #       ccache --zero-stats
  #   #   - name: Configure CMake
  #     env:
  #       CC: ccache clang
  #       CXX: ccache clang++
  #     run: |
  #       mkdir -p build
  #       cd build
  #       cmake -DCMAKE_BUILD_TYPE=Release \
  #             -DBUILD_TESTS=ON \
  #             -DUSE_ICU=ON \
  #             -DUSE_MYSQL=ON \
  #             -DMYGRAMDB_PORTABLE_BUILD=ON \
  #             ..
  #   #   - name: Build
  #     run: |
  #       cd build
  #       make -j$(sysctl -n hw.ncpu)
  #   #   - name: Show ccache statistics
  #     run: ccache --show-stats
  #   #   - name: Run tests
  #     run: |
  #       cd build
  #       ctest --output-on-failure --parallel $(sysctl -n hw.ncpu)
  #   #   - name: Test binary
  #     run: |
  #       # Test help
  #       ./build/bin/mygramdb --help
  #   #       # Test version
  #       ./build/bin/mygramdb --version
  #   #       # Test config validation
  #       ./build/bin/mygramdb -t examples/config-minimal.yaml
  #   #   - name: Upload build artifacts
  #     if: failure()
  #     uses: actions/upload-artifact@v4
  #     with:
  #       name: build-logs-macos
  #       path: |
  #         build/CMakeFiles/*.log
  #         build/Testing/Temporary/

  docker-build:
    name: Docker Build Test
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: false
        load: true
        tags: mygramdb:test
        cache-from: type=gha,scope=docker-build
        cache-to: type=gha,mode=max,scope=docker-build

    - name: Test Docker image
      run: |
        # Test help command
        docker run --rm mygramdb:test --help

        # Test version command
        docker run --rm mygramdb:test --version

        # Test config generation and validation
        docker run --rm -e MYSQL_HOST=testdb -e TABLE_NAME=test mygramdb:test test-config
