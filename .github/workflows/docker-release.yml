name: Docker Release

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger on version tags like v1.0.0, v2.1.3, etc.
  workflow_dispatch:  # Allow manual trigger

env:
  REGISTRY_GHCR: ghcr.io
  REGISTRY_DOCKERHUB: docker.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write  # Required for pushing to ghcr.io

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY_GHCR }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    # Optional: Log in to Docker Hub
    # Uncomment and set DOCKERHUB_USERNAME and DOCKERHUB_TOKEN secrets
    # - name: Log in to Docker Hub
    #   uses: docker/login-action@v3
    #   with:
    #     registry: ${{ env.REGISTRY_DOCKERHUB }}
    #     username: ${{ secrets.DOCKERHUB_USERNAME }}
    #     password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: |
          ${{ env.REGISTRY_GHCR }}/${{ env.IMAGE_NAME }}
        # Uncomment to also push to Docker Hub
        # ${{ env.REGISTRY_DOCKERHUB }}/${{ env.IMAGE_NAME }}
        tags: |
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=semver,pattern={{major}}
          type=raw,value=latest,enable={{is_default_branch}}

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        platforms: linux/amd64,linux/arm64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Generate release notes
      id: release_notes
      run: |
        cat << EOF > release_notes.md
        ## Docker Images

        This release includes multi-architecture Docker images:

        ### Pull from GitHub Container Registry
        \`\`\`bash
        docker pull ${{ env.REGISTRY_GHCR }}/${{ env.IMAGE_NAME }}:${GITHUB_REF#refs/tags/}
        docker pull ${{ env.REGISTRY_GHCR }}/${{ env.IMAGE_NAME }}:latest
        \`\`\`

        ### Supported Architectures
        - linux/amd64
        - linux/arm64

        ### Quick Start
        \`\`\`bash
        # Using environment variables (recommended)
        docker run -d --name mygramdb \\
          -p 11016:11016 \\
          -e MYSQL_HOST=your-mysql-host \\
          -e MYSQL_USER=repl_user \\
          -e MYSQL_PASSWORD=your_password \\
          -e MYSQL_DATABASE=mydb \\
          -e TABLE_NAME=articles \\
          -e REPLICATION_SERVER_ID=12345 \\
          -v mygramdb-data:/var/lib/mygramdb \\
          ${{ env.REGISTRY_GHCR }}/${{ env.IMAGE_NAME }}:${GITHUB_REF#refs/tags/}

        # Or using custom config file
        docker run --rm ${{ env.REGISTRY_GHCR }}/${{ env.IMAGE_NAME }}:${GITHUB_REF#refs/tags/} \
          cat /etc/mygramdb/config.yaml.example > config.yaml
        # Edit config.yaml, then:
        docker run -d --name mygramdb \\
          -p 11016:11016 \\
          -v \$(pwd)/config.yaml:/etc/mygramdb/config.yaml:ro \\
          -v mygramdb-data:/var/lib/mygramdb \\
          -e SKIP_CONFIG_GEN=true \\
          ${{ env.REGISTRY_GHCR }}/${{ env.IMAGE_NAME }}:${GITHUB_REF#refs/tags/} \\
          mygramdb -c /etc/mygramdb/config.yaml
        \`\`\`
        EOF

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        body_path: release_notes.md
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  test-image:
    name: Test Docker Image
    needs: build-and-push
    runs-on: ubuntu-latest

    steps:
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY_GHCR }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Pull and test image
      run: |
        docker pull ${{ env.REGISTRY_GHCR }}/${{ env.IMAGE_NAME }}:${GITHUB_REF#refs/tags/}

        # Test help command
        echo "Testing --help..."
        docker run --rm ${{ env.REGISTRY_GHCR }}/${{ env.IMAGE_NAME }}:${GITHUB_REF#refs/tags/} --help

        # Test version command
        echo "Testing --version..."
        docker run --rm ${{ env.REGISTRY_GHCR }}/${{ env.IMAGE_NAME }}:${GITHUB_REF#refs/tags/} --version

        # Test config generation and validation
        echo "Testing config generation..."
        docker run --rm \
          -e MYSQL_HOST=testdb \
          -e TABLE_NAME=test \
          ${{ env.REGISTRY_GHCR }}/${{ env.IMAGE_NAME }}:${GITHUB_REF#refs/tags/} \
          test-config

        echo "Docker image test passed!"
